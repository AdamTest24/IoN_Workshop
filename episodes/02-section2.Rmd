---
title: "Neuro-Image Handling"
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How an image is read in Python?
- What does masking do?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Explaining data in images
- Understanding image masking 

::::::::::::::::::::::::::::::::::::::::::::::::

## Image Handling 

### Reading and Processing Images
In biology, we often deal with images, for example from microscopy and different medical imaging modalities. In many cases, we wish to extract some quantitative information from these images. The focus of this session is to read and process images in Python. This includes:

- Working with 2-dimensional images
- Creating and applying binary image masks
- Working with 2-dimensional colour images, and interpreting colour channels

First, we want to read in an image. For this part of the lesson, we use a 2D image of brain part,Cerebellum, as an example. We use Matplotlib’s `image` module, from which we import `imread` to store the image in a variable called image. The function `imread` can interpret many different image formats, including jpg, png and tif images.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
#use_python("/Users/sabaferdous/envL2D/bin/python3")
use_virtualenv("r-env")
```

```{python}
from matplotlib.pyplot import subplots, show

from matplotlib.image import imread
```

```{python}
image = imread('fig/Cerebellum.jpg')

fig, ax = subplots()

ax.imshow(image);

show()
```

```{python}
image.shape
```

This tells us that our image is composed of 154 by 327 data units, or pixels as we are dealing with an image. It is equivalent to the image resolution. The array has three dimensions.  

```{python}
image[0, 0]
```

The color intensities go up to 255. This is because RGB (red, green and blue) colours are defined within the range 0-255. 

Let us now use matplotlib.pyplot’s imshow function to plot the section of image to see what it looks like. The x and y coordinates are chosen to specify section of the image. 

```{python}
fig, ax = subplots()

ax.imshow(image[50:70, 60:100]);

ax.set_xticklabels(());
ax.set_yticklabels(());

show()
```

Each square is a pixel and it has one value. So how exactly are the pixel values assigned? By the numbers stored in the Numpy array, image.

```{python}
fig, ax = subplots()

ax.imshow(image[:,:, 2], cmap='gray');

ax.set_xticklabels(());
ax.set_yticklabels(());

show()
```

Here we assigned a grey colour map.


Now that we know that the images are composed of a set of intensities that are just numbers in a Numpy array, we can start using these numbers to process our image.

As a first approach, we can plot a histogram of the original image intensities. We use the `.ravel()` method to turn the original 154 x 327 array into a one-dimensional array with 503,58 values. This rearrangement allows the inclusion of an image as a single column in a matrix or dataframe!

The histogram plot shows how many of the intensities are found in one layer of this image:

```{python}
layer = 2

fig, ax = subplots()

ax.hist(image[:, :, layer][image[:, :, layer] < 255].ravel(), bins=500);

show()
```

```{python}
image.size
```

```{python}
from PIL import Image

image = Image.open('fig/Cerebellum.jpg')

fig, ax = subplots()

ax.imshow(image);

show()
```

```{python}
type(image)
```


```{python}
image.show()
```

```{python}
image.entropy()
```

```{python}
image.rotate(-90, expand=True)

```

## Image Masking


```{python}
from matplotlib.image import imread
from matplotlib.pyplot import subplots, show
```

```{python}
image = imread('fig/rose.jpg')

fig, ax = subplots()

ax.imshow(image);

show()
```

### Transpose Image
```{python}
image.shape
```

```{python}
image_t = image.transpose((1, 0, 2))

fig, ax = subplots()

ax.imshow(image_t)

show()

```

### Only red Component

```{python}
fig, ax = subplots()

ax.imshow(image_t[:, :, 0]);

show()
```

### Histogram of Red Component

```{python}
fig, ax, = subplots()

ax.hist(image_t[:, :, 0].ravel(), bins=500);

show()
```

### Masking the Red Component
```{python}
threshold = 90

mask = image_t[:, :, 0] < threshold

image_masked = image_t[:, :, 0] * mask

fig, ax = subplots(ncols=3)

ax[0].imshow(image_t[:, :, 0], cmap='gray')
ax[1].imshow(mask, cmap='gray')
ax[2].imshow(image_masked, cmap='gray');

fig.tight_layout()

show()
```

### False Colour
```{python}
fig, ax = subplots()

ax.imshow(image_masked);

show()
```

### Apply mask to all layers
Choose grey value for background

```{python}
image_new = image_t.copy()

grey_value = 100

image_new[mask, :] = grey_value


fig, ax = subplots()

ax.imshow(image_new);

show()
```

```{python}
fig.savefig('fig/rose_masked.png', format='png')
```


:::::::::::::::::::::::::::::::::::::keypoints 

- `imread` function is used to read images.
- `ravel` function flattens a multi-dimentional array into a single array.
- Image masking help in identifying objects based on colur intensities.

::::::::::::::::::::::::::::::::::::::::::::::::
[r-markdown]: https://rmarkdown.rstudio.com/
